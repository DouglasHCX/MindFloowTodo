package com.example.mindflow

import java.time.Instant
import java.time.LocalDate
import java.time.ZoneId
import java.util.Locale
import kotlin.math.roundToInt

// ==========================================
// 1. æ•°æ®ç±»å®šä¹‰
// ==========================================

data class WeeklyScore(
    val execution: Int,  // æ‰§è¡ŒåŠ›
    val focus: Int,      // ä¸“æ³¨åº¦
    val balance: Int,    // å¹³è¡¡æ€§
    val resilience: Int, // æ”»åšåŠ›
    val activity: Int,   // æ´»è·ƒåº¦
    val totalScore: Int  // æ€»åˆ†
)

data class KeywordItem(
    val tag: String,
    val description: String
)

data class WeeklyReportData(
    val score: WeeklyScore,
    val keywords: List<KeywordItem>,
    val summary: String,
    val title: String
)

// ==========================================
// 2. æ ¸å¿ƒç®—æ³•é€»è¾‘ (å«æµ·é‡éšæœºæ–‡æ¡ˆåº“)
// ==========================================

object WeeklyAnalysisEngine {

    // --- å…³é”®è¯åº“ ---
    private val keywordLibrary = mapOf(
        "ä»£ç " to ("ğŸ’» èµ›åšå·¥åŒ " to "é”®ç›˜æ•²å‡»å£°æ˜¯ä½ æœ¬å‘¨æœ€ç¾å¦™çš„BGMã€‚"),
        "Bug" to ("ğŸ› å®³è™«å…‹æ˜Ÿ" to "è¿™ä¸€å‘¨ï¼Œä½ è®©ä¸–ç•Œçš„é”™è¯¯åˆå°‘äº†ä¸€äº›ã€‚"),
        "ä¿®å¤" to ("ğŸ”§ ç»´ä¿®å¤§å¸ˆ" to "ç¼ç¼è¡¥è¡¥åˆä¸‰å¹´ï¼Œä½ çš„è€å¿ƒå€¼å¾—ç§°èµã€‚"),
        "ä¼šè®®" to ("ğŸ—£ï¸ èŒä¸šå¼€ä¼šäºº" to "åœ¨æ— æ•°çš„è®¨è®ºä¸­ï¼Œä½ æŠ“ä½äº†é‡ç‚¹ã€‚"),
        "æ²Ÿé€š" to ("ğŸ¤ è¿ç»“è€…" to "ä½ æ˜¯å›¢é˜Ÿçš„èƒ¶æ°´ï¼Œè¿æ¥ç€æ¯ä¸€ä¸ªå­¤å²›ã€‚"),
        "é‚®ä»¶" to ("ğŸ“§ ä¿¡ä½¿" to "ä½ çš„æ–‡å­—ç©¿è¶Šç½‘çº¿ï¼Œä¸ä»…ä¼ é€’ä¿¡æ¯ï¼Œæ›´ä¼ é€’ä»·å€¼ã€‚"),
        "è®¾è®¡" to ("ğŸ¨ é€ æ¢¦å¸ˆ" to "åœ¨åƒç´ çš„ä¸–ç•Œé‡Œï¼Œä½ æ„å»ºäº†ç¾çš„ç§©åºã€‚"),
        "æ–‡æ¡£" to ("ğŸ“ è®°å½•è€…" to "ä½ ç•™ä¸‹çš„ä¸ä»…æ˜¯æ–‡å­—ï¼Œæ›´æ˜¯å›¢é˜Ÿçš„èµ„äº§ã€‚"),
        "PPT" to ("ğŸ“Š æ¼”è¯´å®¶" to "ä½ ç”¨å¹»ç¯ç‰‡è®²è¿°äº†ä¸€ä¸ªåˆä¸€ä¸ªç²¾å½©çš„æ•…äº‹ã€‚"),
        "æ•°æ®" to ("ğŸ”¢ ç®—åŠ›æ‹…å½“" to "åœ¨å†°å†·çš„æ•°å­—ä¸­ï¼Œä½ æ´å¯Ÿåˆ°äº†æ¸©æš–çš„è¶‹åŠ¿ã€‚"),
        "é˜…è¯»" to ("ğŸ“š é˜…ä¹¦ä¸‡å·" to "çµé­‚å’Œèº«ä½“ï¼Œæ€»æœ‰ä¸€ä¸ªåœ¨è·¯ä¸Šï¼Œè¿™å‘¨æ˜¯çµé­‚ã€‚"),
        "ä¹¦" to ("ğŸ•¯ï¸ å®ˆå¤œäºº" to "ä¹¦æœ¬æ˜¯ä½ å¯¹æŠ—å¹³åº¸ä¸–ç•Œçš„æ­¦å™¨ã€‚"),
        "å­¦ä¹ " to ("ğŸŒ± è¿›åŒ–ä¸­" to "ä»Šå¤©çš„ä½ ï¼Œç‰ˆæœ¬å·åˆ +0.1 äº†ã€‚"),
        "ç¬”è®°" to ("âœï¸ çƒ‚ç¬”å¤´" to "è®°å¿†ä¼šè¤ªè‰²ï¼Œä½†ä½ çš„ç¬”è®°ä¼šæ°¸å­˜ã€‚"),
        "è‹±è¯­" to ("ğŸŒ ä¸–ç•Œå…¬æ°‘" to "è¯­è¨€æ˜¯ä½ é€šå¾€å¹¿é˜”ä¸–ç•Œçš„é’¥åŒ™ã€‚"),
        "ä¹°" to ("ğŸ›’ å‰æ‰‹å…š" to "é’±æ²¡æœ‰æ¶ˆå¤±ï¼Œåªæ˜¯æ¢äº†ä¸€ç§æ–¹å¼é™ªä¼´ä½ ã€‚"),
        "é€›" to ("ğŸš¶ åŸå¸‚æ¼«æ¸¸è€…" to "ä½ ç”¨è„šæ­¥ä¸ˆé‡äº†è¿™åº§åŸå¸‚çš„æ¸©æŸ”ã€‚"),
        "åƒ" to ("ğŸ¥˜ å­¤ç‹¬ç¾é£Ÿå®¶" to "å”¯æœ‰ç¾é£Ÿä¸çˆ±ä¸å¯è¾œè´Ÿï¼Œè¿™å‘¨ä½ æ²¡è¾œè´Ÿç¾é£Ÿã€‚"),
        "å–" to ("ğŸ¥¤ å¿«ä¹æ°´" to "è¿™ä¸€å£çš„å¿«ä¹ï¼Œè¶³ä»¥æŠµæ¶ˆä¸€å¤©çš„ç–²æƒ«ã€‚"),
        "ç”µå½±" to ("ğŸ¬ æ­¤æ—¶æ­¤åˆ»" to "åœ¨åˆ«äººçš„æ•…äº‹é‡Œï¼Œæµç€è‡ªå·±çš„æ³ªï¼ˆæˆ–ç¬‘ï¼‰ã€‚"),
        "æ¸¸æˆ" to ("ğŸ® å¤´å·ç©å®¶" to "åœ¨è™šæ‹Ÿä¸–ç•Œé‡Œï¼Œä½ ä¹Ÿæ˜¯å½“ä¹‹æ— æ„§çš„è‹±é›„ã€‚"),
        "æ”¶æ‹¾" to ("ğŸ§¹ æ–­èˆç¦»" to "æ‰«é™¤å†…å¿ƒçš„å°˜åŸƒï¼Œä»æ•´ç†æˆ¿é—´å¼€å§‹ã€‚"),
        "åšé¥­" to ("ğŸ³ ä¸­åå°å½“å®¶" to "äººé—´çƒŸç«æ°”ï¼Œæœ€æŠšå‡¡äººå¿ƒã€‚"),
        "ç¡è§‰" to ("ğŸ’¤ è¡¥è§‰å…½" to "è¿™å‘¨è¾›è‹¦äº†ï¼Œæ¢¦é‡Œä»€ä¹ˆéƒ½æœ‰ã€‚"),
        "è·‘æ­¥" to ("ğŸƒ è¿½é£è€…" to "é£å£°åœ¨è€³è¾¹å‘¼å•¸ï¼Œé‚£æ˜¯è‡ªç”±çš„å£°éŸ³ã€‚"),
        "å¥èº«" to ("ğŸ‹ï¸ ä¸¾é“ç‹‚é­”" to "è‚Œè‚‰çš„é…¸ç—›ï¼Œæ˜¯èº«ä½“ç»™ä½ çš„æˆé•¿å›é¦ˆã€‚"),
        "ç‘œä¼½" to ("ğŸ§˜ æŸ”æœ¯å¤§å¸ˆ" to "åœ¨å‘¼å¸ä¹‹é—´ï¼Œä½ æ‰¾åˆ°äº†å†…å¿ƒçš„å¹³é™ã€‚"),
        "æ•£æ­¥" to ("ğŸŒ³ æ£®æ—æµ´" to "æ…¢ä¸‹æ¥ï¼Œå»æ„Ÿå—è·¯è¾¹çš„ä¸€æœµèŠ±å¼€ã€‚"),
        "çƒ¦" to ("â›ˆï¸ ä½æ°”å‹" to "æŠ±æŠ±ä½ ã€‚ä¹Œäº‘æ€»ä¼šæ•£å»ï¼Œå¤ªé˜³ç…§å¸¸å‡èµ·ã€‚"),
        "ç´¯" to ("ğŸ”‹ ç”µé‡å‘Šæ€¥" to "å…è®¸è‡ªå·±åœæœºç»´æŠ¤ï¼Œæ˜¯ä¸ºäº†æ›´å¥½åœ°é‡å¯ã€‚"),
        "å¼€å¿ƒ" to ("âœ¨ å°ç¡®å¹¸" to "æ”¶è—è¿™ä»½å¿«ä¹ï¼Œå®ƒæ˜¯ä½ å‰è¡Œçš„ç‡ƒæ–™ã€‚"),
        "éš¾" to ("ğŸ§— æ”€ç™»è€…" to "å›°éš¾åƒå¼¹ç°§ï¼Œä½ å¼ºå®ƒå°±å¼±ã€‚ä½ åšåˆ°äº†ï¼"),
        "æ€¥" to ("ğŸ”¥ æ•‘ç«é˜Ÿå‘˜" to "åœ¨æ··ä¹±ä¸­å»ºç«‹ç§©åºï¼Œè¿™æ˜¯ä½ çš„è¶…èƒ½åŠ›ã€‚")
    )

    fun analyze(todos: List<TodoItem>, weekStart: LocalDate, weekEnd: LocalDate): WeeklyReportData {
        val zone = ZoneId.systemDefault()

        val completedTasks = todos.filter {
            it.isDone && it.completedAt != null && isDateInRange(it.completedAt!!, weekStart, weekEnd, zone)
        }
        val missedTasks = todos.filter {
            !it.isDone && it.dueDate != null && isDateInRange(it.dueDate, weekStart, weekEnd, zone)
        }
        val totalTasksCount = completedTasks.size + missedTasks.size

        // --- ç»´åº¦è®¡ç®— ---
        val execution = if (totalTasksCount == 0) 0 else ((completedTasks.size.toFloat() / totalTasksCount) * 100).toInt()

        val highPriorityCompleted = completedTasks.count { it.priority == 3 }
        val focus = if (completedTasks.isEmpty()) 0 else ((highPriorityCompleted.toFloat() / completedTasks.size) * 100).toInt().coerceAtLeast(40)

        val balance = calculateBalance(completedTasks)

        val totalChars = completedTasks.sumOf { it.title.length + it.content.length }
        val resilience = (totalChars / 5).coerceIn(0, 100)

        val activeDays = completedTasks.map {
            Instant.ofEpochMilli(it.completedAt!!).atZone(zone).toLocalDate()
        }.distinct().size
        val activity = (activeDays * 15).coerceIn(0, 100)

        val totalScore = (execution * 0.3 + focus * 0.2 + balance * 0.1 + resilience * 0.2 + activity * 0.2).toInt()

        // --- ç”Ÿæˆå†…å®¹ ---
        val generatedKeywords = generateKeywords(completedTasks, execution)
        val summary = generateSmartSummary(completedTasks, missedTasks, activeDays, execution, balance, generatedKeywords, totalScore)
        val title = getTitle(totalScore, execution, activeDays)

        return WeeklyReportData(
            score = WeeklyScore(execution, focus, balance, resilience, activity, totalScore),
            keywords = generatedKeywords,
            summary = summary,
            title = title
        )
    }

    private fun calculateBalance(tasks: List<TodoItem>): Int {
        if (tasks.isEmpty()) return 0
        val categories = tasks.groupBy { it.category }
        val categoryCount = categories.size
        var baseScore = (categoryCount * 20).coerceIn(0, 80)
        val maxCategoryCount = categories.values.maxOfOrNull { it.size } ?: 0
        val dominanceRate = maxCategoryCount.toFloat() / tasks.size
        if (dominanceRate > 0.6) baseScore -= 20
        else if (dominanceRate < 0.4 && categoryCount >= 3) baseScore += 20
        return baseScore.coerceIn(0, 100)
    }

    private fun generateKeywords(tasks: List<TodoItem>, execution: Int): List<KeywordItem> {
        val results = mutableListOf<KeywordItem>()
        val allText = tasks.joinToString { it.title + it.content }
        keywordLibrary.forEach { (key, value) ->
            if (allText.contains(key)) results.add(KeywordItem(value.first, value.second))
        }
        if (results.isEmpty() && tasks.isNotEmpty()) results.add(KeywordItem("âœ¨ å®å¹²å®¶", "ä½ æ²¡è¯´ä»€ä¹ˆå¤§è¯ï¼Œä½†æŠŠäº‹æƒ…éƒ½åšå®Œäº†ã€‚æ²‰é»˜æ˜¯é‡‘ã€‚"))
        if (execution >= 90) results.add(KeywordItem("âš¡ æ•ˆç‡å¸", "è¿™ç§å®Œæˆç‡ï¼Œä¸ä»…æ˜¯æ‰‹é€Ÿå¿«ï¼Œæ›´æ˜¯å¿ƒæµåœ¨ç‡ƒçƒ§ï¼"))
        else if (execution < 50 && tasks.isNotEmpty()) results.add(KeywordItem("ğŸ¢ æ…¢æ…¢æ¥", "è™½ç„¶æ…¢äº†ä¸€ç‚¹ï¼Œä½†åªè¦åœ¨å‰è¿›ï¼Œå°±æ˜¯å¥½çš„ã€‚"))
        return results.distinctBy { it.tag }.take(4)
    }

    // ==========================================
    // 3. æ–‡æ¡ˆç”Ÿæˆå™¨ (æµ·é‡éšæœºæ–‡æ¡ˆ)
    // ==========================================

    private fun generateSmartSummary(
        completed: List<TodoItem>,
        missed: List<TodoItem>,
        activeDays: Int,
        execution: Int,
        balance: Int,
        keywords: List<KeywordItem>,
        totalScore: Int
    ): String {
        val sb = StringBuilder()

        // --- Part 1: å¼€å¤´ (æ ¹æ®æ´»è·ƒåº¦) ---
        val introText = when {
            activeDays >= 6 -> listOf(
                "è¿™ä¸€å‘¨ï¼Œä½ ç®€ç›´æ˜¯å…¨å‹¤æˆ˜å£«ï¼å‡ ä¹æ¯ä¸€å¤©éƒ½åœ¨ä¸ºç›®æ ‡è€Œæˆ˜ã€‚",
                "Data don't lie: ä½ è¿™ä¸€å‘¨çš„æ´»è·ƒåº¦ä»¤äººæƒŠå¹ï¼Œè¿ç»­çš„äº§å‡ºéå¸¸äº†ä¸èµ·ã€‚",
                "å“‡ï¼Œçœ‹æ¥ä½ è¿™å‘¨è¿›å…¥äº†â€œå¿ƒæµâ€çŠ¶æ€ï¼Œæ•´æ•´ $activeDays å¤©éƒ½åœ¨é«˜æ•ˆè¿è½¬ã€‚",
                "è¿™å°±æ˜¯è‡ªå¾‹çš„åŠ›é‡å—ï¼Ÿä½ çš„æ´»è·ƒåº¦æ›²çº¿ç®€ç›´å®Œç¾ã€‚",
                "ä¸€å‘¨ä¸ƒå¤©ï¼Œä½ æ²¡æœ‰ç»™è‡ªå·±ç•™å¤ªå¤šå€Ÿå£ï¼Œè¿™ç§åšæŒæœ¬èº«å°±æ˜¯ä¸€ç§èƒœåˆ©ã€‚"
            ).random()
            activeDays >= 4 -> listOf(
                "è¿™æ˜¯ä¸€ä¸ªå……å®ä¸”æœ‰èŠ‚å¥çš„ä¸€å‘¨ï¼Œä½ åœ¨ $activeDays å¤©é‡Œç•™ä¸‹äº†å¥‹æ–—çš„è¶³è¿¹ã€‚",
                "ä¸é”™å“¦ï¼Œè¿™å‘¨ä½ ä¿æŒäº†å¾ˆå¥½çš„å·¥ä½œ/ç”Ÿæ´»èŠ‚å¥ï¼Œäº§å‡ºç¨³å®šã€‚",
                "å›é¡¾è¿™å‘¨ï¼Œä½ åœ¨å¤§éƒ¨åˆ†æ—¶é—´é‡Œéƒ½æŒæ§äº†å±€é¢ã€‚",
                "ç¨³æ‰ç¨³æ‰“çš„ä¸€å‘¨ï¼Œä½ åœ¨ $activeDays å¤©é‡Œéƒ½æœ‰æ‰€æ”¶è·ã€‚",
                "è¿™å‘¨çš„çŠ¶æ€åˆšåˆšå¥½ï¼Œæ—¢æ²¡æœ‰è¿‡åº¦ç´§ç»·ï¼Œä¹Ÿæ²¡æœ‰å½»åº•èººå¹³ã€‚"
            ).random()
            else -> listOf(
                "è¿™å‘¨çœ‹èµ·æ¥ä½ ç»™è‡ªå·±æ”¾äº†ä¸€äº›å‡ï¼Œæˆ–è€…æ˜¯åœ¨è“„åŠ›å‡†å¤‡å¤§æ‹›ï¼Ÿ",
                "è™½ç„¶æ´»è·ƒå¤©æ•°ä¸å¤šï¼Œä½†â€œå°‘å³æ˜¯å¤šâ€ï¼Œå…³é”®åœ¨äºå®Œæˆäº†ä»€ä¹ˆã€‚",
                "çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªæ¯”è¾ƒè½»æ¾çš„æ˜ŸæœŸï¼Œæˆ–è€…æ˜¯æœ‰äº›çªå‘æƒ…å†µæ‰“ä¹±äº†èŠ‚å¥ï¼Ÿ",
                "ä¸ç®¡æ˜¯ä¼‘æ¯è¿˜æ˜¯è°ƒæ•´ï¼Œåªè¦å†æ¬¡å‡ºå‘ï¼Œæ°¸è¿œéƒ½ä¸æ™šã€‚",
                "è¿™å‘¨çš„èŠ‚å¥æ¯”è¾ƒèˆ’ç¼“ï¼Œå¸Œæœ›ä½ ç§¯æ”’äº†è¶³å¤Ÿçš„èƒ½é‡è¿æ¥ä¸‹å‘¨ã€‚"
            ).random()
        }
        sb.append(introText).append("\n\n")

        // --- Part 2: äº®ç‚¹åˆ†æ (æ ¹æ®æœ€é«˜åˆ†ç»´åº¦) ---
        val highlightText = when {
            execution > 85 -> listOf(
                "æ‰§è¡ŒåŠ›æ˜¯ä½ æœ¬å‘¨çš„å¿…æ€æŠ€ï¼æ¸…å•ä¸Šçš„ä»»åŠ¡å‡ ä¹è¢«â€œå›¢ç­â€ï¼Œè¿™ç§æŒæ§æ„Ÿå¤ªæ£’äº†ã€‚",
                "ä½ çš„æ‰§è¡Œæ•ˆç‡ç®€ç›´å¯æ€•ï¼Œä»»åŠ¡åˆ—è¡¨åœ¨ä½ é¢å‰ç‘Ÿç‘Ÿå‘æŠ–ã€‚",
                "çœ‹ç€ä¸€ä¸ªä¸ªè¢«åˆ’æ‰çš„ä»»åŠ¡ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç§è«åçš„çˆ½æ„Ÿï¼Ÿä½ åšåˆ°äº†ï¼",
                "è¨€å‡ºå¿…è¡Œï¼Œè¿™æ˜¯å¯¹ä½ æœ¬å‘¨è¡¨ç°æœ€å¥½çš„æ³¨è§£ã€‚",
                "æ•ˆç‡çˆ†è¡¨ï¼å¦‚æœä»»åŠ¡ç®¡ç†æœ‰æ®µä½ï¼Œä½ è¿™å‘¨ç»å¯¹æ˜¯ç‹è€…ã€‚"
            ).random()
            balance > 80 -> listOf(
                "è¿™å‘¨ä½ è¿‡å¾—éå¸¸ä¸°å¯Œå¤šå½©ï¼å·¥ä½œã€ç”Ÿæ´»ã€è‡ªæˆ‘æå‡æ ·æ ·ä¸è½ï¼Œè¿™æ‰æ˜¯ç”Ÿæ´»è¯¥æœ‰çš„æ ·å­ã€‚",
                "ä½ ä¸ä»…æ˜¯ä¸ªå·¥ä½œè€…ï¼Œæ›´æ˜¯ä¸ªç”Ÿæ´»å®¶ã€‚è¿™ç§å¹³è¡¡æ„Ÿæ˜¯å¾ˆéš¾å¾—çš„èƒ½åŠ›ã€‚",
                "æ²¡æœ‰æˆä¸ºæ— æƒ…çš„ä»»åŠ¡æœºå™¨ï¼Œè€Œæ˜¯å…¼é¡¾äº†å¤šä¸ªç»´åº¦ï¼Œä¸ºä½ ç‚¹èµï¼",
                "ä½ çš„ç²¾åŠ›åˆ†é…éå¸¸ç§‘å­¦ï¼Œè¿™ç§å¯æŒç»­çš„å‘å±•æ¨¡å¼å€¼å¾—ä¿æŒã€‚",
                "å¤šé¢æ‰‹ï¼ä½ è¯æ˜äº†ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—å’Œè¿œæ–¹ï¼ˆä»¥åŠå¥èº«ï¼‰ã€‚"
            ).random()
            keywords.any { it.tag.contains("æå®¢") || it.tag.contains("bug") || it.tag.contains("ä»£ç ") } -> listOf(
                "æ•°æ®æ˜¾ç¤ºï¼Œä½ æœ¬å‘¨åœ¨æŠ€æœ¯é¢†åŸŸæŠ•å…¥äº†å¤§é‡å¿ƒè¡€ï¼Œè„‘ç»†èƒè¾›è‹¦äº†ï¼",
                "è™½ç„¶å¤´å‘å¯èƒ½å°‘äº†å‡ æ ¹ï¼ˆå¼€ç©ç¬‘ï¼‰ï¼Œä½†ä¸“ä¸šèƒ½åŠ›çš„æå‡æ˜¯å®æ‰“å®çš„ã€‚",
                "æ²‰æµ¸åœ¨é€»è¾‘çš„ä¸–ç•Œé‡Œï¼Œä½ æ„å»ºäº†å±äºè‡ªå·±çš„ç§©åºã€‚",
                "å‘æŠ€æœ¯å¤§ç¥è‡´æ•¬ï¼ä½ è§£å†³çš„æ¯ä¸€ä¸ªéš¾é¢˜ï¼Œéƒ½æ˜¯é€šå¾€é«˜é˜¶ä¹‹è·¯çš„å°é˜¶ã€‚",
                "è¿™ä¸€å‘¨å……æ»¡äº†æŠ€æœ¯å«é‡ï¼Œä½ çš„äº§å‡ºéå¸¸æœ‰ä»·å€¼ã€‚"
            ).random()
            totalScore > 80 -> listOf(
                "ç»¼åˆæ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä»½æ¥è¿‘å®Œç¾çš„ç­”å·ï¼Œå„æ–¹é¢è¡¨ç°éƒ½å¾ˆä¼˜ç§€ã€‚",
                "å…­è¾¹å½¢æˆ˜å£«ï¼æ— è®ºå“ªä¸ªç»´åº¦ï¼Œä½ éƒ½å¤„ç†å¾—æ¸¸åˆƒæœ‰ä½™ã€‚",
                "è¿™å‘¨çš„çŠ¶æ€å¥½åˆ°è®©äººå«‰å¦’ï¼Œè¯·åŠ¡å¿…ä¿æŒè¿™ç§åŠ¿å¤´ï¼",
                "æ— éœ€å¤šè¨€ï¼Œä¼˜ç§€çš„ä¹ æƒ¯å·²ç»åˆ»è¿›äº†ä½ çš„DNAã€‚",
                "éå¸¸å‡ºè‰²çš„ä¸€å‘¨ï¼Œä½ å·²ç»æˆä¸ºäº†æ›´å¥½çš„è‡ªå·±ã€‚"
            ).random()
            else -> listOf(
                "è¿™å‘¨ä½ å¹³ç¨³åº¦è¿‡ï¼Œè™½ç„¶æ²¡æœ‰æƒŠæ¶›éª‡æµªï¼Œä½†æ¯ä¸€ä¸ªå¯¹å‹¾éƒ½æ˜¯è®¤çœŸç”Ÿæ´»çš„è¯æ®ã€‚",
                "å¹³å‡¡çš„ä¸€å‘¨ï¼Œä½†æ­£æ˜¯è¿™äº›å¹³å‡¡çš„æ—¥å­å †ç Œå‡ºäº†ä¸å¹³å‡¡çš„æœªæ¥ã€‚",
                "ä½ æŒ‰éƒ¨å°±ç­åœ°å®Œæˆäº†è®¡åˆ’ï¼Œè¿™ç§ç¨³å®šæ€§æœ¬èº«å°±æ˜¯ä¸€ç§èƒ½åŠ›ã€‚",
                "æ²¡æœ‰å¤§èµ·å¤§è½ï¼Œåªæœ‰è„šè¸å®åœ°ã€‚è¿™æ ·çš„èŠ‚å¥å…¶å®å¾ˆèˆ’æœã€‚",
                "ç”Ÿæ´»åœ¨ç»§ç»­ï¼Œä½ åœ¨å‰è¡Œï¼Œè¿™å°±è¶³å¤Ÿäº†ã€‚"
            ).random()
        }
        sb.append(highlightText).append("\n\n")

        // --- Part 3: é—®é¢˜ä¸å»ºè®® (æ ¹æ®æœªå®Œæˆæƒ…å†µ) ---
        val adviceText = if (missed.isNotEmpty()) {
            val highPriorityMissed = missed.any { it.priority == 3 }
            if (highPriorityMissed) listOf(
                "ä¸è¿‡ï¼Œè¿˜æœ‰å‡ ä¸ªæ ‡çº¢çš„é«˜ä¼˜ä»»åŠ¡è¢«é—ç•™äº†ã€‚å»ºè®®ä¸‹å‘¨ä¸€ä¼˜å…ˆâ€œåƒæ‰é‚£åªé’è›™â€ã€‚",
                "æ³¨æ„å“¦ï¼Œé‡è¦çš„ä»»åŠ¡ä¸èƒ½ä¸€æ‹–å†æ‹–ï¼Œä¸‹å‘¨å°è¯•å…ˆæ”»å…‹é‚£ä¸ªæœ€éš¾çš„å§ã€‚",
                "æœ‰äº›ç¡¬éª¨å¤´è¿˜æ²¡å•ƒä¸‹æ¥ï¼Œä¸è¦è®©å®ƒä»¬å˜æˆå¿ƒé‡Œçš„çŸ³å¤´ï¼Œä¸‹å‘¨ä¸€é¼“ä½œæ°”æå®šå®ƒï¼",
                "è™½ç„¶å¤§éƒ¨åˆ†å®Œæˆäº†ï¼Œä½†é‚£ä¸ªé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¿˜åœ¨ç­‰ä½ ï¼Œåˆ«å¿˜äº†å®ƒã€‚",
                "ç‘•ä¸æ©ç‘œï¼Œä½†å¦‚æœèƒ½æŠŠé‚£ä¸ªé‡è¦ä»»åŠ¡æå®šï¼Œå°±æ›´å®Œç¾äº†ã€‚"
            ).random()
            else listOf(
                "è¿˜æœ‰ ${missed.size} ä¸ªå°å°¾å·´æ²¡æ”¶å®Œã€‚å¦‚æœä¸é‡è¦äº†ï¼Œå¤§èƒ†åˆ é™¤ä¹Ÿæ— å¦¨ã€‚",
                "å‰©ä¸‹å‡ ä¸ªå°ä»»åŠ¡æ²¡åšå®Œï¼Œæ²¡å…³ç³»ï¼Œé‡æ–°è¯„ä¼°ä¸€ä¸‹å®ƒä»¬æ˜¯å¦çœŸçš„éœ€è¦åšã€‚",
                "åˆ«è®©æœªå®Œæˆçš„ä»»åŠ¡å¸¦æ¥ç„¦è™‘ï¼Œä½ å¯ä»¥é€‰æ‹©å°†å®ƒä»¬è¿ç§»åˆ°ä¸‹å‘¨ï¼Œæˆ–è€…ç›´æ¥â€œæ–­èˆç¦»â€ã€‚",
                "è™½ç„¶æœ‰äº›ä»»åŠ¡æ²¡åšå®Œï¼Œä½†åªè¦æ ¸å¿ƒç›®æ ‡è¾¾æˆäº†ï¼Œè¿™äº›ç»†ææœ«èŠ‚ä¸å¿…æŒ‚æ€€ã€‚",
                "ç»™å¾…åŠåˆ—è¡¨å‡å‡è´Ÿå§ï¼Œä¸‹å‘¨è½»è£…ä¸Šé˜µã€‚"
            ).random()
        } else {
            listOf(
                "ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œä½ ç«Ÿç„¶æ¸…ç©ºäº†æ‰€æœ‰é¢„è®¾ä»»åŠ¡ï¼ä¸‹å‘¨æˆ–è®¸å¯ä»¥æŒ‘æˆ˜æ›´æœ‰éš¾åº¦çš„ç›®æ ‡ï¼Ÿ",
                "ä»»åŠ¡åˆ—è¡¨ç©ºç©ºå¦‚ä¹Ÿï¼Œè¿™ç§æ„Ÿè§‰å¤ªæ¸…çˆ½äº†ï¼",
                "æ— æ•Œæ˜¯å¤šä¹ˆå¯‚å¯ï¼Œä½ å·²ç»æ¶ˆç­äº†æ‰€æœ‰æ•Œäººï¼ˆä»»åŠ¡ï¼‰ã€‚",
                "çœ‹æ¥ä½ çš„è®¡åˆ’éå¸¸åˆç†ï¼Œæˆ–è€…ä½ çš„æ‰§è¡ŒåŠ›è¶…å‡ºäº†é¢„æœŸã€‚",
                "å®Œç¾æ”¶å®˜ï¼æ²¡æœ‰ä»»ä½•æ‹–å»¶ï¼Œäº«å—è¿™ç§ä¸€èº«è½»çš„æ„Ÿè§‰å§ã€‚"
            ).random()
        }
        sb.append(adviceText).append("\n\n")

        // --- Part 4: æš–å¿ƒç»“è¯­ (éšæœº) ---
        val closingText = listOf(
            "æ— è®ºè¿™å‘¨è¿‡å¾—å¦‚ä½•ï¼Œéƒ½å·²æˆå®šå±€ã€‚å»åƒé¡¿å¥½çš„ï¼ŒçŠ’åŠ³ä¸€ä¸‹è‡ªå·±å§ï¼ğŸ²",
            "å¥½å¥½ä¼‘æ¯ï¼Œæ— è®ºæ˜¯ç¡ä¸ªæ‡’è§‰è¿˜æ˜¯çœ‹åœºç”µå½±ã€‚MindFlow æœŸå¾…ä¸‹å‘¨è§ï¼ğŸŒ¹",
            "æ„¿ä½ å‘¨æœ«æ„‰å¿«ï¼ŒæŠŠçƒ¦æ¼éƒ½æŠ›åœ¨è„‘åï¼Œåªç•™ä¸‹å¿«ä¹ã€‚âœ¨",
            "å……å¥½ç”µï¼Œä¸‹å‘¨æˆ‘ä»¬ç»§ç»­å¹¶è‚©ä½œæˆ˜ï¼ğŸ’ª",
            "ç”Ÿæ´»æ˜æœ—ï¼Œä¸‡ç‰©å¯çˆ±ã€‚ä¸‹å‘¨ä¹Ÿè¦ç»§ç»­åŠ æ²¹é¸­ï¼ğŸ¦†",
            "åˆ«å¿˜äº†ï¼Œä½ å·²ç»å¾ˆæ£’äº†ã€‚æ™šå®‰ï¼Œå¥½æ¢¦ã€‚ğŸŒ™",
            "ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚ä¸‹å‘¨è§ï¼ğŸŒŠ",
            "è®°å¾—ç»™è‡ªå·±ä¸€ä¸ªå¤§å¤§çš„æ‹¥æŠ±ã€‚ğŸ«‚",
            "ç°åœ¨çš„åŠªåŠ›ï¼Œéƒ½æ˜¯ä¸ºäº†ä»¥åæœ‰æ›´å¤šé€‰æ‹©çš„æƒåˆ©ã€‚åŠ æ²¹ï¼ğŸš€",
            "å‘¨æœ«æ„‰å¿«ï¼æŠŠæ—¶é—´æµªè´¹åœ¨ç¾å¥½çš„äº‹ç‰©ä¸Šå§ã€‚ğŸ¨"
        ).random()
        sb.append(closingText)

        return sb.toString()
    }

    private fun getTitle(score: Int, execution: Int, activeDays: Int): String {
        return when {
            score >= 90 -> "ğŸ‘‘ æ•ˆç‡ç‹è€…"
            score >= 80 -> "ğŸ”¥ è¿›å‡»çš„å·¨äºº"
            score >= 70 -> "ğŸŒŸ é—ªè€€æ–°æ˜Ÿ"
            score >= 60 -> "ğŸŒ± ç¨³æ­¥å‰è¡Œ"
            activeDays == 0 -> "ğŸ’¤ æ·±åº¦ä¼‘çœ "
            execution == 100 -> "âœ¨ å®Œç¾ä¸»ä¹‰è€…"
            else -> "ğŸ§© è“„åŠ¿å¾…å‘"
        }
    }

    private fun isDateInRange(millis: Long, start: LocalDate, end: LocalDate, zone: ZoneId): Boolean {
        val date = Instant.ofEpochMilli(millis).atZone(zone).toLocalDate()
        return !date.isBefore(start) && !date.isAfter(end)
    }
}